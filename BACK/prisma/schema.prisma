generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  TEACHER
  STUDENT
}

enum ActivityType {
  EXAM
  QUIZ
  SUMMARY
  PRESENTATION
  EMAIL
  SURVEY
  RUBRIC
  LESSON_PLAN
  GAME
  CHATBOT
  WRITING_CORRECTION
}

enum ActivityVisibility {
  PRIVATE
  PUBLIC
}

enum AIProvider {
  OPENAI
  GEMINI
  OLLAMA
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  firstName String
  lastName  String
  role      UserRole @default(TEACHER)
  credits   Int      @default(500)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  activities     Activity[]
  creditHistory  CreditHistory[]
  studentProfile StudentProfile?
  teacherProfile TeacherProfile?

  @@index([email])
  @@index([role])
}

model Activity {
  id          String             @id @default(uuid())
  title       String
  description String?
  type        ActivityType
  visibility  ActivityVisibility @default(PRIVATE)
  content     Json
  subject     String
  grade       String
  aiProvider  AIProvider
  creditCost  Int
  userId      String
  user        User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt

  @@index([userId])
  @@index([type])
  @@index([visibility])
  @@index([subject])
  @@index([createdAt])
}

model CreditHistory {
  id          String      @id @default(uuid())
  userId      String
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  amount      Int
  type        String
  description String
  aiProvider  AIProvider?
  createdAt   DateTime    @default(now())

  @@index([userId])
  @@index([createdAt])
}

model Institution {
  id          String   @id @default(uuid())
  name        String
  description String?
  address     String?
  phone       String?
  email       String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relationships
  grades          Grade[]
  students        StudentProfile[]
  teachers        TeacherProfile[]
  invitationCodes InvitationCode[]

  @@index([name])
}

model Grade {
  id          String   @id @default(uuid())
  name        String // e.g., "5th Grade A", "Math 101"
  description String?
  subject     String? // e.g., "Mathematics", "Science"
  level       String? // e.g., "Elementary", "High School"
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Foreign Keys
  institutionId String
  teacherId     String // Teacher in charge of this grade

  // Relationships
  institution     Institution      @relation(fields: [institutionId], references: [id], onDelete: Cascade)
  teacher         TeacherProfile   @relation(fields: [teacherId], references: [id], onDelete: Restrict)
  students        StudentProfile[]
  invitationCodes InvitationCode[]

  @@index([institutionId])
  @@index([teacherId])
  @@index([name])
}

model StudentProfile {
  id             String   @id @default(uuid())
  enrollmentDate DateTime @default(now())
  studentId      String? // Optional internal student ID
  notes          String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Foreign Keys
  userId        String @unique
  institutionId String
  gradeId       String

  // Relationships
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  institution Institution @relation(fields: [institutionId], references: [id], onDelete: Restrict)
  grade       Grade       @relation(fields: [gradeId], references: [id], onDelete: Restrict)

  @@index([institutionId])
  @@index([gradeId])
}

model TeacherProfile {
  id             String   @id @default(uuid())
  subject        String? // Primary subject taught
  employmentDate DateTime @default(now())
  title          String? // e.g., "Professor", "Instructor"
  notes          String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Foreign Keys
  userId        String @unique
  institutionId String

  // Relationships
  user           User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  institution    Institution @relation(fields: [institutionId], references: [id], onDelete: Restrict)
  gradesInCharge Grade[] // Grades where this teacher is in charge

  @@index([institutionId])
}

model InvitationCode {
  id          String    @id @default(uuid())
  code        String    @unique // Unique invitation code
  description String? // Optional description of the code purpose
  maxUses     Int? // Null = unlimited uses, otherwise limit uses
  usedCount   Int       @default(0)
  expiresAt   DateTime? // Optional expiration date
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Foreign Keys
  gradeId       String
  institutionId String
  createdBy     String // Teacher who created this code

  // Relationships
  grade       Grade       @relation(fields: [gradeId], references: [id], onDelete: Cascade)
  institution Institution @relation(fields: [institutionId], references: [id], onDelete: Cascade)

  @@index([code])
  @@index([gradeId])
  @@index([institutionId])
  @@index([isActive])
}
