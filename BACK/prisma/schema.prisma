generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  TEACHER
  STUDENT
}

enum ActivityType {
  EXAM
  QUIZ
  SUMMARY
  PRESENTATION
  EMAIL
  SURVEY
  RUBRIC
  LESSON_PLAN
  GAME
  CHATBOT
  WRITING_CORRECTION
  FLASHCARDS
  ESSAY
  WORKSHEET
  PROJECT
}

enum ActivityVisibility {
  PRIVATE
  PUBLIC
}

enum AIProvider {
  OPENAI
  GEMINI
  OLLAMA
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  firstName String
  lastName  String
  role      UserRole @default(TEACHER)
  credits   Int      @default(500)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  activities         Activity[]
  creditHistory      CreditHistory[]
  studentProfile     StudentProfile?
  teacherProfile     TeacherProfile?
  assignedActivities ActivityGrade[] // Activities assigned by this user

  @@index([email])
  @@index([role])
}

model Activity {
  id          String             @id @default(uuid())
  title       String
  description String?
  type        ActivityType
  visibility  ActivityVisibility @default(PRIVATE)
  content     Json
  subject     String
  gradeLevel  String?            // Educational level metadata (e.g., "Secundaria", "Primaria")
  aiProvider  AIProvider
  creditCost  Int
  userId      String
  user        User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt

  // Many-to-many relationship with grades
  activityGrades ActivityGrade[]

  @@index([userId])
  @@index([type])
  @@index([visibility])
  @@index([subject])
  @@index([createdAt])
}

// Junction table for Activity-Grade many-to-many relationship
model ActivityGrade {
  id         String   @id @default(uuid())
  activityId String
  gradeId    String
  assignedBy String // Teacher who assigned the activity to this grade
  assignedAt DateTime @default(now())

  // Relationships
  activity       Activity @relation(fields: [activityId], references: [id], onDelete: Cascade)
  grade          Grade    @relation(fields: [gradeId], references: [id], onDelete: Cascade)
  assignedByUser User     @relation(fields: [assignedBy], references: [id])

  @@unique([activityId, gradeId])
  @@index([activityId])
  @@index([gradeId])
  @@index([assignedBy])
}

model CreditHistory {
  id          String      @id @default(uuid())
  userId      String
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  amount      Int
  type        String
  description String
  aiProvider  AIProvider?
  createdAt   DateTime    @default(now())

  @@index([userId])
  @@index([createdAt])
}

model Institution {
  id          String   @id @default(uuid())
  name        String
  description String?
  address     String?
  phone       String?
  email       String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relationships
  grades          Grade[]
  students        StudentProfile[]
  teachers        TeacherProfile[]
  invitationCodes InvitationCode[]

  @@index([name])
}

model Grade {
  id          String   @id @default(uuid())
  name        String // e.g., "5th Grade A", "Math 101"
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Foreign Keys
  institutionId String
  teacherId     String // Teacher in charge of this grade

  // Relationships
  institution     Institution      @relation(fields: [institutionId], references: [id], onDelete: Cascade)
  teacher         TeacherProfile   @relation(fields: [teacherId], references: [id], onDelete: Restrict)
  students        StudentProfile[] @relation("LegacyGrade") // Legacy one-to-many
  studentGrades   StudentGrade[]   // New many-to-many relationship
  invitationCodes InvitationCode[]
  activityGrades  ActivityGrade[] // Activities assigned to this grade

  @@index([institutionId])
  @@index([teacherId])
  @@index([name])
}

// Junction table for Student-Grade many-to-many relationship
model StudentGrade {
  id         String   @id @default(uuid())
  studentId  String
  gradeId    String
  enrolledAt DateTime @default(now())
  isActive   Boolean  @default(true)

  // Relationships
  student StudentProfile @relation(fields: [studentId], references: [id], onDelete: Cascade)
  grade   Grade          @relation(fields: [gradeId], references: [id], onDelete: Cascade)

  @@unique([studentId, gradeId])
  @@index([studentId])
  @@index([gradeId])
}

model StudentProfile {
  id             String   @id @default(uuid())
  enrollmentDate DateTime @default(now())
  studentId      String? // Optional internal student ID
  notes          String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Foreign Keys
  userId        String @unique
  institutionId String
  gradeId       String? // Keep temporarily for migration, will be removed later

  // Relationships
  user        User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  institution Institution    @relation(fields: [institutionId], references: [id], onDelete: Restrict)
  grade       Grade?         @relation("LegacyGrade", fields: [gradeId], references: [id], onDelete: Restrict)
  grades      StudentGrade[] // New many-to-many relationship

  @@index([institutionId])
  @@index([gradeId])
}

model TeacherProfile {
  id             String   @id @default(uuid())
  subject        String? // Primary subject taught
  employmentDate DateTime @default(now())
  title          String? // e.g., "Professor", "Instructor"
  notes          String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Foreign Keys
  userId        String @unique
  institutionId String

  // Relationships
  user           User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  institution    Institution @relation(fields: [institutionId], references: [id], onDelete: Restrict)
  gradesInCharge Grade[] // Grades where this teacher is in charge

  @@index([institutionId])
}

model InvitationCode {
  id          String    @id @default(uuid())
  code        String    @unique // Unique invitation code
  description String? // Optional description of the code purpose
  maxUses     Int? // Null = unlimited uses, otherwise limit uses
  usedCount   Int       @default(0)
  expiresAt   DateTime? // Optional expiration date
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Foreign Keys
  gradeId       String
  institutionId String
  createdBy     String // Teacher who created this code

  // Relationships
  grade       Grade       @relation(fields: [gradeId], references: [id], onDelete: Cascade)
  institution Institution @relation(fields: [institutionId], references: [id], onDelete: Cascade)

  @@index([code])
  @@index([gradeId])
  @@index([institutionId])
  @@index([isActive])
}
